---
title: "Draft1"
author: "Jacy;CD"
date: "2020/12/14"
output: html_document
---
# SET UP
```{r packages}
library(stm)
library(quanteda)
library(lubridate)
library(RTextTools)
library(igraph)
library(ggplot2)
library(tidyverse)
library(tidytext)

```
```{r load files}
setwd("C:/Users/Chendi/Desktop/DATA 727/all data")
data<-read.csv("pooleddata.csv")
```
# 1.Introduction
# 2.Related Work
# 3.Data Source and Methods
## 3.1 Data Collection
## 3.2 Model Specification
```{r Data preparing}
processed <- textProcessor(data$selftext, metadata = data)
out <- prepDocuments(processed$documents,
                     processed$vocab,
                     processed$meta, 
                     lower.thresh = 15)
docs <- out$documents
vocab <- out$vocab
meta <-out$meta
```

```{r Models}
M1<-stm(documents = out$documents, 
                       vocab =out$vocab,
                       K = 20,
                       prevalence =~ratio+s(created_utc),
                       max.em.its = 50, data = out$meta,
                       init.type = "Spectral")
M2<-stm(documents = out$documents, 
                       vocab =out$vocab,
                       K = 20,
                       prevalence =~ratio+s(created_utc),
                       content = ~mode,
                       max.em.its = 50, data = out$meta,
                       init.type = "Spectral")

```
# 4.Results and Discussion
```{r prepare}
out$meta$ID <- seq.int(nrow(out$meta))
theta <- data.frame(M1$theta)
theta$ID <- seq.int(nrow(theta))
all <- merge(out$meta[,-c(1:2)], theta)
all %>% 
  select(ID, created_utc, starts_with('X'))
all_1 <- gather(data = all, key = topic, value = theta, starts_with('X'), factor_key=TRUE)

```
##4.1 Topic Summary
```{r Table3 topic summary}
labelTopics(M1, 1:20)

#proportion
por<-all_1 %>% 
  group_by(topic) %>% 
  summarize(avg_theta = mean(theta))
```
##4.2 Topic Prevalence Analysis
```{r preparing}
prep_M1 <- estimateEffect(1:20 ~ratio+s(created_utc), 
                       M1,
                       meta = out$meta, 
                       uncertainty = "Global")
```







```{r Figure2 }
group1<-all_1 %>% 
  filter(topic==c("X2","X10","X11","X14","X16","X19"))%>%
  group_by(month, topic) %>% 
  summarize(total = n(),
            med_theta = median(theta),
            avg_theta = mean(theta))
group1%>% 
  ggplot(aes(x=month,y=avg_theta,color=topic)) +
  geom_line() +
  labs(x = 'Month', y = 'Topic Prevalence')+
  scale_x_continuous(breaks=c(3,5,7,9))+
  theme(legend.position = "bottom")+
  scale_color_discrete(labels=c("T2 school reopen",                                               "T10 course communication", 
                                 "T11 school\n-covid test",
                                 "T11 course\n-technology",
                                 "T16 course\n-housekeeping",
                                "T19 course\n-mode and registeration"))+
  ggtitle('Figure 2')

```

```{r Figure3-4 }

group2_1<-all_1 %>% 
  filter(topic==c("X3","X5","X9"))%>%
  group_by(month, topic) %>% 
  summarize(total = n(),
            med_theta = median(theta),
            avg_theta = mean(theta))
group2_1%>% 
  ggplot(aes(x=month,y=avg_theta,color=topic)) +
  geom_line() +
  labs(x = 'Month', y = 'Topic Prevalence') +
  scale_x_continuous(breaks=c(3,5,7,9))+
  theme(legend.position = "bottom")+
  scale_color_discrete(labels=c("T3 social life-action",                                          "T5 social life-covid", 
                                 "T9 social life-place"))+
  ggtitle('Figure3')
 
group2_2<-all_1 %>% 
  filter(topic==c("X12","X13","X17","X18"))%>%
  group_by(month, topic) %>% 
  summarize(total = n(),
            med_theta = median(theta),
            avg_theta = mean(theta))

group2_2%>% 
  ggplot(aes(x=month,y=avg_theta,color=topic)) +
  geom_line() +
  labs(x = 'Month', y = 'Topic Prevalence') +
  scale_x_continuous(breaks=c(3,5,7,9))+
  theme(legend.position = "bottom")+
  scale_color_discrete(labels=c("T12 financials\n        -funding",
                                 "T13 mental health",
                                "T17 financials\n        -jobs",
                                 "T18 housing"))+
  ggtitle('Figure4')

```

##4.3 Topic Content Analysis 
```{r topics}
labelTopics(M2, 1:20)
```

```{r}
prep_M2<- estimateEffect(1:20 ~ratio+s(created_utc)+mode, 
                       M2,
                       meta = out$meta, 
                       uncertainty = "Global")

summary(prep_M2)
```

```{r Table5 }
por_2<-all_1 %>% 
  group_by(topic) %>% 
  summarize(avg_theta = mean(theta))%>%
  .[-c(1,2,6,7,8,9,10,11,15,20),]
por_2$topic<-gsub("X","T",por_2$topic)
a<-ifelse(por_2$topic=="T4"|por_2$topic=="T5"|por_2$topic=="T12"|por_2$topic=="T14"|por_2$topic=="T19",-1,1)
por_2$mode<-ifelse(por_2$topic=="T4"|por_2$topic=="T5"|por_2$topic=="T12"|por_2$topic=="T14"|por_2$topic=="T19","Remote","Hybrid")
por_2$avf_theta_2<-por_2$avg_theta*a

ggplot(data = por_2,aes(x = topic, y =avf_theta_2,fill = as.factor(mode))) + 
  geom_bar(stat = 'identity') +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks.y = element_blank(),
        axis.line.x = element_line(),
        axis.title = element_blank()) +
  labs(title  = 'Topic Proportion',fill='Teaching Mode')+
  scale_y_continuous(breaks=c(-.05,0,.05))+
  theme(plot.title = element_text(hjust = 0.5))+
  coord_flip()

```
# 5. Conclusion and Implication

#Appendix

```{r Figure 1 fig.height = 10, fig.width =10}
M1_a<-tidy(M1)
M1_a %>%
  group_by(topic) %>%
  top_n(10, beta) %>%
 ungroup() %>%
    mutate(topic = paste0("Topic ", topic),
         term = reorder_within(term, beta, topic)) %>%
  ggplot(aes(term, beta, fill = as.factor(topic))) +
  geom_col(alpha = 0.8, show.legend = FALSE) +
  facet_wrap(~ topic, scales = "free_y") +
  coord_flip() +
  scale_x_reordered() +
  labs(x = NULL, y = expression(beta),
       title = "Highest word probabilities for each topic",
       subtitle = "Different words are associated with different topics")

```

```{r Figure 2 fig.height = 10, fig.width =10}

M1_b<- tidytext::tidy(M1, matrix = "theta")
ggplot(M1_b, aes(y=gamma, x=as.factor(topic))) +
  geom_histogram(alpha = 0.8, show.legend = FALSE) +
  facet_wrap(~ topic, ncol = 3) +
  labs(title = "Distribution of document probabilities for each topic",
       y = "Number of documents", x = expression(theta))
