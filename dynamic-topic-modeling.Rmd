---
title: "Dynamic Topic Model "
author: "Jacy;CD"
date: "2020/11/21"
output:
  word_document: default
  pdf_document: default
  html_document:
    df_print: paged
---
#set up
```{r include=F}
if(!require(stm)) install.packages("stm")
if(!require(quanteda)) install.packages("quanteda")
if(!require(tidyverse)) install.packages("tidyverse")
if(!require(lubridate)) install.packages("lubridate")
if(!require(RTextTools)) install.packages("RTextTools")
if(!require(igraph)) install.packages("igraph")
if(!require(wordcloud)) install.packages("wordcloud")
library(stm)
library(quanteda)
library(lubridate)
library(RTextTools)
library(igraph)
library(wordcloud)
library(ggplot2)
```
#load files
```{r include=FALSE,message=FALSE}
setwd("C:/Users/赵晨笛/Desktop/DATA 727/all data")
data<-read.csv("pooleddata.csv")

```

#prepare: associate text with metadata
#The Structural Topic Model allows researchers to flexibly estimate a topic model that includes document-level metadata. Estimation is accomplished through a fast variational approximation.
```{r results='hide'}
#creates a document term matrix that can be supplied directly to the stm model fitting function.
processed <- textProcessor(data$selftext, metadata = data)

#stemming (reducing words to their root form), dropping punctuation and stop word removal (e.g., the, is, at)
#prepDocuments also removes infrequent terms depending on the user-set parameter lower.thresh.
out <- prepDocuments(processed$documents,
                     processed$vocab,
                     processed$meta, 
                     lower.thresh = 15)
docs <- out$documents
vocab <- out$vocab
meta <-out$meta

```
```{r}
#The utility function plotRemoved will plot the number of words and documents removed for different thresholds.
plotRemoved(processed$documents, lower.thresh = seq(1, 200, by = 100))
```
# Estimate the STM


#A feature of the stm function is that “prevalence” can be expressed as a formula that can include multiple covariates and factorial or continuous covariates(in our case:time).
```{r results='hide'}
redditPrevFit <- stm(documents = out$documents, 
                       vocab =out$vocab,
                       K = 20,
                       prevalence =~mode+s(created_utc),
                       max.em.its = 75, data = out$meta,
                       init.type = "Spectral")

```


#Understand: Interpreting the STM by plotting and inspecting results
#Understanding topics through words and example documents
# poprotion; weighted: log(); ns();bs()
```{r}
labelTopics(redditPrevFit, 1:20)
```

#Estimating metadata and topic relationships
```{r results='hide'}
prep <- estimateEffect(1:20 ~ mode+s(created_utc), 
                       redditPrevFit,
                       meta = out$meta, 
                       uncertainty = "Global")

```


#Visualize: Presenting STM results


#1.estimated topic proportions
```{r}
plot(redditPrevFit, type = "summary", xlim = c(0, 0.3))
```

#2. Graphical display of topic prevalence, Take the example of Topic 2
```{r}
plot(prep, 
     "created_utc", 
      method = "continuous", 
      topics =2,
      model = z, 
      printlegend = FALSE, 
      xais = "n", 
      xlab = "Time(2020)")
monthseq <- seq(from = as.Date("2020-03-01"),to = as.Date("2020-11-01"), by = "month")
monthnames <- months(monthseq)
axis(1,at = as.numeric(monthseq) - min(as.numeric(monthseq)),labels = monthnames)


```


```{r results='hide'}
RedditContent <- stm(out$documents, 
                       out$vocab, 
                     K = 20,
                     prevalence =~mode+s(created_utc), 
                     content =~mode,
                     max.em.its = 75,
                     data = out$meta, 
                     init.type = "Spectral")
```


# 3.Graphical display of topical contrast within and between topics
```{r}
plot(RedditContent, type = "perspectives", topics = 11)

plot(RedditContent, type = "perspectives", topics = c(2,11))
```

#5 Effect of the covariate
```{r}
plot(prep, 
     covariate = "mode", 
     topics = c(2,5,11,19),
     model = redditPrevFit, 
     method = "difference",
     cov.value1 = "Remote",
     cov.value2 = "Hybrid",
     xlab = "Remote ... Hybrid",
     main = "Effect of Teaching Mode",
     xlim = c(-.1, .1),
     labeltype = "custom",
     custom.labels = c('2', '5','11','19'))
  
```

# 5.wordclouds
```{r}
cloud(redditPrevFit, topic = 11, scale = c(2,.25))

```
